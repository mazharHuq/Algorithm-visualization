<!DOCTYPE html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
<title>Segment Tree</title>
<link rel="icon" type="image/png" href="img/favicon.png" />

<!--css-->
<link rel="stylesheet" href="css/normalize.css">
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="css/viz.css">

<link rel="stylesheet" href="css/st.css">

<!--js-->
<script src="js/external/jquery-1.10.2.js"></script>
<script src="js/external/jquery-ui.js"></script>
<script src="js/external/d3.v3.js"></script>
<script src="js/viz.js"></script>
<script src="js/common.js"></script>
<script src="js/actions/st_actions.js"></script>
<!--script src="//connect.facebook.net/en_US/all.js"></script-->
<!-- more scripts are below-->

<!--fonts-->
<link href="fonts/silkscreen/stylesheet.css" rel='stylesheet' type='text/css'>
<link href='fonts/PTSans/stylesheet.css' rel='stylesheet' type='text/css'>

</head>

<body>

    <div id="viz"></div>

<script src="js/graph_library/constant.js"></script>
<script src="js/graph_library/properties.js"></script>
<script src="js/graph_library/helperObjects.js"></script>
<script src="js/graph_library/misc.js"></script>
<script src="js/graph_library/Widget.js"></script>
<script src="js/graph_library/GraphWidget.js"></script>
<script src="js/graph_library/GraphVertexWidget.js"></script>
<script src="js/graph_library/GraphEdgeWidget.js"></script>
<script src="js/Widgets/StWidget.js"></script>

<script type="text/javascript">
  $('#play').hide();

  //this viz-specific code
  var stWidget = new ST();
  var gw = stWidget.getGraphWidget();

  $('#title-Min').click(function() {
    if(isPlaying) { stop(); }
    showActionsPanel();
    hideStatusPanel();
    hideCodetracePanel();
    stWidget.init(getRandomData(), 0);
  });
  $('#title-Max').click(function() {
    if(isPlaying) { stop(); }
    showActionsPanel();
    hideStatusPanel();
    hideCodetracePanel();
    stWidget.init(getRandomData(), 1);
  });
  $('#title-Sum').click(function() {
    if(isPlaying) { stop(); }
    showActionsPanel();
    hideStatusPanel();
    hideCodetracePanel();
    stWidget.init(getRandomData(), 2);
  });

  //stWidget.binaryTree(getRandomData(), 0);
  stWidget.init(getRandomData(), 0);

  function getCreateData() {
    var input = $('#v-create').val();
    if (input == "") {
      vertexAmt = Math.floor((Math.random()*(stWidget.maxVertexAllowed-5) + 5));
      var initArr = [];
      while(initArr.length < vertexAmt)
        initArr.push(Math.floor(1+Math.random()*(stWidget.maxValueAllowed-1)));
      return initArr;
    } else {
      input = input.replace(/\s*/g,"").split(',');
      for (i in input) {
        input[i] = input[i];
        if (typeof input[i] == "NaN") {
          alert("Invaild input");
          return null;
        }
      }
      return input;
    }
  }

  function getRandomData() {
    vertexAmt = Math.floor((Math.random()*(stWidget.maxVertexAllowed-5) + 5));
    var initArr = [];
    while(initArr.length < vertexAmt)
      initArr.push(Math.floor(1+Math.random()*(stWidget.maxValueAllowed-1)));
    return initArr;
  }

  function create() {
    var data;
    if(isPlaying) { stop(); }
    setTimeout( function() {
      if ((mode=="exploration") && ((data = getCreateData()) != null)) {
        stWidget.create(data);
        $('#current-action').show();
        $('#current-action p').html("Build tree");
        $('#progress-bar').slider( "option", "max", gw.getTotalIteration()-1);
        closeCreate();
        triggerRightPanels();
        isPlaying = true;
      }
    }, 500)
  }

  function randomm(){
    if(isPlaying) { stop(); }
    vertexAmt = Math.floor((Math.random()*(stWidget.maxVertexAllowed-5) + 5));
    var initArr = [];
    while(initArr.length < vertexAmt)
      initArr.push(Math.floor(1+Math.random()*(stWidget.maxValueAllowed-1)));
    setTimeout( function() {
      if ((mode=="exploration") && ((data = initArr) != null)) {
        stWidget.create(data);
        $('#current-action').show();
        $('#current-action p').html("Build tree");
        $('#progress-bar').slider( "option", "max", gw.getTotalIteration()-1);
        closeCreate();
        triggerRightPanels();
        isPlaying = true;
      }
    }, gw.getAnimationDuration())
  }
  
  function randomLL(){
    if(isPlaying) { stop(); }
    vertexAmt = Math.floor((Math.random()*(stWidget.maxVertexAllowed-5) + 5));
    var initArr = [];
    while(initArr.length < vertexAmt)
      initArr.push(Math.floor(1+Math.random()*(stWidget.maxValueAllowed-1)));
    var i=0;
    var j=0;
    for (i=0;i<vertexAmt;i++){
      for (j=i+1;j<vertexAmt;j++){
        if (initArr[i]>initArr[j]){
          var k=initArr[i];
          initArr[i]=initArr[j];
          initArr[j]=k;
        }
      }
    }
    setTimeout( function() {
      if ((mode=="exploration") && ((data = initArr) != null)) {
        stWidget.create(data);
        $('#current-action').show();
        $('#current-action p').html("Build tree");
        $('#progress-bar').slider( "option", "max", gw.getTotalIteration()-1);
        closeCreate();
        triggerRightPanels();
        isPlaying = true;
      }
    }, gw.getAnimationDuration())
  }

  function rmq(){
    if(isPlaying) { stop(); }
    setTimeout( function() {
      var input_l = $('#v-rmq-l').val();
      var input_r = $('#v-rmq-r').val();
      input_l = parseInt(input_l);
      input_r = parseInt(input_r);
      if((mode=="exploration") && stWidget.rmq(input_l, input_r)) {
        $('#current-action').show();
        $('#current-action p').html("Query RMQ in ["+ input_l + ", " + input_r + "]");
        $('#progress-bar').slider( "option", "max", gw.getTotalIteration()-1);
        closeRMQ();
        triggerRightPanels();
        isPlaying = true;
      }
    }, gw.getAnimationDuration());
  }

  function update(){
    if(isPlaying) { stop(); }
    setTimeout( function() {
      var input_l = $('#v-update-l').val();
      var input_r = $('#v-update-r').val();
      var input_value=$('#v-update-value').val();
      input_l = parseInt(input_l);
      input_r = parseInt(input_r);
      input_value=parseInt(input_value);
      if((mode=="exploration")&&stWidget.update(input_l, input_r,input_value)) {
        $('#current-action').show();
        $('#current-action p').html("Query Update in ["+ input_l + ", " + input_r + "]");
        $('#progress-bar').slider( "option", "max", gw.getTotalIteration()-1);
        closeUpdate();
        triggerRightPanels();
        isPlaying = true;
      }
    }, gw.getAnimationDuration());
  }

  //playback controls might fit better in viz.js, but put here in case some viz does not use GraphWidgetNew.js
  var isPaused = false;
  function isAtEnd() {
    return (gw.getCurrentIteration()==(gw.getTotalIteration()-1));
  }
  
  function pause() {
    if(isPlaying) {
      isPaused = true;
      gw.pause();
      $('#play').show();
      $('#pause').hide();
    }
  }
  function play() {
    if(isPlaying) {
      isPaused = false;
      $('#pause').show();
      $('#play').hide();
      if(isAtEnd()) {
        gw.replay();
      } else {
        gw.play();
      }
    }
  }
  function stepForward() {
    if(isPlaying) {
      pause();
      gw.forceNext(250);
    }
  }
  function stepBackward() {
    if(isPlaying) {
      pause();
      gw.forcePrevious(250);  
    }
  }
  function goToBeginning() {
    if(isPlaying) {
      gw.jumpToIteration(0,0);
      pause();
    }
  }
  function goToEnd() {
    if(isPlaying) {
      gw.jumpToIteration(gw.getTotalIteration()-1,0);
      pause();
    }
  }
  function stop() {
    gw.stop();
    isPaused = false;
    isPlaying = false;
    $('#pause').show();
    $('#play').hide();
    $('#current-action').hide();
  }
  
  //shortcut keys for playback controls
  $(document).keydown( function(event) {
    if(event.which == 32) { //spacebar
      if(isPaused) { play(); } else { pause(); }
    } else if(event.which == 37) { //left arrow
      stepBackward();
    } else if(event.which == 39) { //right arrow
      stepForward();
    } else if(event.which == 35) { //end
      stop();
    } else if (event.which == 189) { //minus
      var d = (2200-gw.getAnimationDuration())-100;
      if(d > 0) {
        $("#speed-input").slider("value", d);
      } else {
        $("#speed-input").slider("value", 0);
      }
    } else if (event.which == 187) { //plus
      var d = (2200-gw.getAnimationDuration())+100;
      if(d <= 2000) {
        $("#speed-input").slider("value", d);
      } else {
        $("#speed-input").slider("value", 2000);
      }
    }
  });
  
  //sliders
  $("#speed-input").slider({
    min: 200,
    max: 2000,
    value: 1700,
    change: function(event, ui) {
      gw.setAnimationDuration(2200-ui.value);
    }
  });
  $("#progress-bar").slider({
    range: "min",
    min: 0,
    value: 0,
    slide: function(event, ui) {
      gw.pause();
      gw.jumpToIteration(ui.value,0);
    },
    stop: function(event, ui) {
      if(!isPaused) { setTimeout( function(){gw.play();}, 500) }
    }
  });
  
</script>

</body>
</html>